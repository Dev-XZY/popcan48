<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>å£è¢‹48ç¿»ç‰Œè®°å½•æ£€ç´¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #f5f5f7;
      padding: 20px;
    }
    .card {
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
      border: none;
    }
    .avatar-box img {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      object-fit: cover;
    }
    .badge-text {
      display: inline-block;
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 999px;
      background: #e9f3ff;
      color: #0d6efd;
    }
    .badge-audio {
      display: inline-block;
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 999px;
      background: #fff3cd;
      color: #856404;
    }
    table {
      font-size: 13px;
    }
    th {
      position: sticky;
      top: 0;
      background-color: #f8f9fa;
      z-index: 1;
    }
    .table-wrapper {
      max-height: 600px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid #e5e5e5;
      background: #fff;
    }
    .highlight-row {
      background-color: #fff3cd !important;
      animation: highlight 2s ease-in-out;
    }
    @keyframes highlight {
      0% { background-color: #ffeb3b; }
      100% { background-color: #fff3cd; }
    }
    .question-content, .answer-content {
      max-width: 300px;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .chat-messages {
      height: 500px;
      overflow-y: auto;
      border: 1px solid #e5e5e5;
      border-radius: 12px;
      padding: 15px;
      background-color: #f8f9fa;
      margin-bottom: 15px;
    }
    .message {
      margin-bottom: 15px;
      display: flex;
      flex-direction: column;
    }
    .message.fan {
      align-items: flex-end;
    }
    .message.idol {
      align-items: flex-start;
    }
    .message-bubble {
      max-width: 70%;
      padding: 10px 15px;
      border-radius: 18px;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .message.fan .message-bubble {
      background-color: hwb(264 71% 0%);
      color: white;
      border-bottom-right-radius: 4px;
    }
    .message.idol .message-bubble {
      background-color: white;
      color: #333;
      border-bottom-left-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .message-time {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
      padding: 0 5px;
    }
    .message-sender {
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 4px;
      padding: 0 5px;
    }
    .message.fan .message-sender {
      text-align: right;
      color: #9c27b0;
    }
    .message.idol .message-sender {
      text-align: left;
      color: #666;
    }
    .result-bar {
      font-size: 13px;
      color: #6c757d;
    }
    .kw-highlight {
      background-color: rgba(255, 0, 0, 0.12);
      color: #c1121f;
      padding: 0 2px;
      border-radius: 4px;
    }
    .sample-list {
      max-height: 240px;
      overflow: auto;
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      padding: 10px;
      background: #fafafa;
    }
    .sample-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    .sample-item:last-child {
      border-bottom: none;
    }
    .sample-meta {
      font-size: 12px;
      color: #6c757d;
    }
    .sample-text {
      font-size: 13px;
      line-height: 1.5;
    }
    .sample-badge {
      display: inline-block;
      padding: 0 6px;
      border-radius: 6px;
      background: #e9f3ff;
      color: #0d6efd;
      font-size: 11px;
      margin-right: 6px;
    }
    tr[style*="cursor: pointer"]:hover {
      background-color: #f8f9fa !important;
    }
    tr[style*="cursor: pointer"] {
      transition: background-color 0.2s;
    }
  </style>
</head>
<body>
<div class="container" style="max-width: 1100px;">
  <div class="card p-4 mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <div class="avatar-box me-3">
          <img src="https://via.placeholder.com/50" alt="avatar">
        </div>
        <div>
          <div>
            <span class="fw-bold" id="selectedNickname">æœªç™»å½•</span>
            <span class="text-muted" id="selectedId" style="margin-left: 4px;"></span>
          </div>
          <div class="text-muted mt-1">
            ä½™é¢ï¼š
            <span class="text-danger fw-bold" id="selectedBalance">--</span>
          </div>
        </div>
      </div>
      <div>
        <button class="btn btn-sm btn-outline-primary me-2" id="refreshBalanceButton">
          åˆ·æ–°ä½™é¢
        </button>
        <button class="btn btn-sm btn-outline-secondary" id="logoutButton">
          é€€å‡ºç™»å½•
        </button>
      </div>
    </div>
  </div>

  <div class="card p-4 mb-4">
    <h5 class="mb-3">ç™»å½•å£è¢‹48è´¦å·ï¼ˆæ‰‹æœºå· + çŸ­ä¿¡éªŒè¯ç ï¼‰</h5>
    <p class="text-muted small">
      ä½¿ç”¨ä¸å£è¢‹48 App ç›¸åŒçš„æ‰‹æœºå·ç™»å½•ã€‚éªŒè¯ç é€šè¿‡å®˜æ–¹é€šé“å‘é€ï¼Œæœ¬é¡µé¢åªè½¬å‘ç™»å½•è¯·æ±‚ã€‚
    </p>

    <form id="smsLoginForm" class="row g-3">
      <div class="col-md-2">
        <label class="form-label fw-bold">åŒºå·</label>
        <input type="text" class="form-control" id="areaCodeInput" value="86">
      </div>
      <div class="col-md-3">
        <label class="form-label fw-bold">æ‰‹æœºå·</label>
        <input type="text" class="form-control" id="mobileInput" placeholder="ä¸å«åŒºå·" required>
      </div>
      <div class="col-md-3 align-self-end">
        <button type="button" class="btn btn-primary w-100" id="sendCodeButton">
          å‘é€éªŒè¯ç 
        </button>
      </div>
      <div class="col-md-2 align-self-end">
        <button type="button" class="btn btn-outline-secondary w-100" id="cancelLoginButton" style="display: none;">
          å–æ¶ˆ
        </button>
      </div>
    </form>

    <div id="verifyCodeSection" class="row g-3 mt-2">
      <div class="col-md-3">
        <label class="form-label fw-bold">éªŒè¯ç </label>
        <input type="text" class="form-control" id="verifyCodeInput" placeholder="è¯·è¾“å…¥çŸ­ä¿¡éªŒè¯ç " maxlength="6" disabled>
      </div>
      <div class="col-md-3 align-self-end">
        <button type="button" class="btn btn-success w-100" id="loginButton" disabled>
          ç¡®è®¤ç™»å½•
        </button>
      </div>
      <div class="col-md-6 align-self-end">
        <span class="text-muted small" id="codeStatus">è¯·å…ˆå‘é€éªŒè¯ç </span>
      </div>
    </div>

    <p class="text-muted small mt-2">
      ç‚¹å‡»"å‘é€éªŒè¯ç "åï¼Œè¯·åœ¨é¡µé¢ä¸­è¾“å…¥çŸ­ä¿¡éªŒè¯ç å¹¶ç‚¹å‡»"ç¡®è®¤ç™»å½•"ã€‚ç™»å½•æˆåŠŸåï¼Œä¸Šé¢çš„æ˜µç§° / ID / ä½™é¢ä¼šè‡ªåŠ¨æ›´æ–°ã€‚
    </p>
  </div>

  <div class="card p-4">
    <h5 class="mb-3">ç¿»ç‰Œè®°å½•æ£€ç´¢</h5>

    <div class="row g-3 mb-3">
      <div class="col-md-12 d-flex align-items-end gap-2">
        <button class="btn btn-primary" id="getAnswerButton">
          è·å– / åˆ·æ–°æˆ‘çš„ç¿»ç‰Œæ•°æ®
        </button>
        <div class="d-flex align-items-center gap-2">
          <label class="form-label mb-0 small text-nowrap">æœ€å¤šè·å–ï¼š</label>
          <select class="form-control form-control-sm" id="maxRecordsSelect" style="width: 120px;">
            <option value="1000">1000 æ¡</option>
            <option value="5000">5000 æ¡</option>
            <option value="10000" selected>10000 æ¡</option>
            <option value="20000">20000 æ¡</option>
            <option value="-1">å…¨éƒ¨ï¼ˆè°¨æ…ï¼‰</option>
          </select>
        </div>
        <button class="btn btn-success" id="exportButton">
          å¯¼å‡º Excel
        </button>
        <button class="btn btn-outline-success" id="previewButton">
          é¢„è§ˆ/ä¸‹è½½
        </button>
      </div>
      <div class="col-md-12">
        <div class="progress" id="loadingProgress" style="display: none; height: 25px;">
          <div class="progress-bar progress-bar-striped progress-bar-animated" 
               id="loadingProgressBar" 
               role="progressbar" 
               style="width: 0%">
            <span id="loadingProgressText">0%</span>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-2">
        <label class="form-label">ç±»å‹ç­›é€‰</label>
        <select class="form-control" id="filterType">
          <option value="">å…¨éƒ¨</option>
          <option value="1">æ–‡å­—</option>
          <option value="2">è¯­éŸ³</option>
          <option value="3">è§†é¢‘</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">çŠ¶æ€ç­›é€‰</label>
        <select class="form-control" id="filterStatus">
          <option value="">å…¨éƒ¨</option>
          <option value="answered">å·²ç¿»</option>
          <option value="returned">é€€å›</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">é¸¡è…¿æ•°æ’åº</label>
        <select class="form-control" id="sortCost">
          <option value="">ä¸æ’åº</option>
          <option value="desc">ä»é«˜åˆ°ä½</option>
          <option value="asc">ä»ä½åˆ°é«˜</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">å¼€å§‹æ—¥æœŸ</label>
        <input type="date" class="form-control" id="filterDateStart">
      </div>
      <div class="col-md-2">
        <label class="form-label">ç»“æŸæ—¥æœŸ</label>
        <input type="date" class="form-control" id="filterDateEnd">
      </div>
      <div class="col-md-2">
        <label class="form-label">æ—¶é—´æ’åº</label>
        <select class="form-control" id="sortTime">
          <option value="">ä¸æ’åº</option>
          <option value="asc">ä»æ—©åˆ°æ™š</option>
          <option value="desc">ä»æ™šåˆ°æ—©</option>
        </select>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-12">
        <label class="form-label">å…³é”®è¯æœç´¢ï¼ˆæé—® / å›ç­”ï¼‰</label>
        <div class="input-group mb-2">
          <input type="text" class="form-control" id="filterKeyword" placeholder="ä¾‹å¦‚ï¼šæŸä¸ªè¯ã€æŸå¥è¯çš„ä¸€éƒ¨åˆ†â€¦">
          <button class="btn btn-outline-secondary" id="searchButton" type="button">æœç´¢</button>
          <button class="btn btn-outline-danger btn-sm" id="clearSearchButton" type="button" style="display: none;">æ¸…é™¤æœç´¢</button>
        </div>
        <div class="d-flex flex-wrap align-items-center gap-3">
          <span class="text-muted small">æœç´¢èŒƒå›´ï¼š</span>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="filterScope" id="filterScopeAll" value="all" checked>
            <label class="form-check-label" for="filterScopeAll">æé—® + å›ç­”</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="filterScope" id="filterScopeQuestion" value="question">
            <label class="form-check-label" for="filterScopeQuestion">åªæ£€ç´¢æé—®</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="filterScope" id="filterScopeAnswer" value="answer">
            <label class="form-check-label" for="filterScopeAnswer">åªæ£€ç´¢å›ç­”</label>
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-2 result-bar">
      <span id="resultCount"></span>
      <div id="paginationInfo" class="text-muted small"></div>
    </div>

    <div class="table-wrapper" id="tableWrapper">
      <table class="table table-sm mb-0">
        <thead>
        <tr>
          <th style="width: 70px;">ç±»å‹</th>
          <th style="width: 120px;">å¶åƒå</th>
          <th style="width: 150px;">æé—®æ—¶é—´</th>
          <th>æé—®å†…å®¹</th>
          <th>å›ç­”å†…å®¹</th>
          <th style="width: 100px;">é¸¡è…¿æ•°</th>
        </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-3">
      <div class="d-flex align-items-center">
        <button class="btn btn-sm btn-outline-primary" id="prevPage" disabled>ä¸Šä¸€é¡µ</button>
        <span class="mx-2">ç¬¬</span>
        <input type="number" class="form-control form-control-sm" id="pageInput" value="1" min="1" style="width: 80px; text-align: center;">
        <span class="mx-2" id="pageInfo">é¡µï¼Œå…± 1 é¡µ</span>
        <button class="btn btn-sm btn-outline-primary ms-2" id="goToPage">è·³è½¬</button>
        <button class="btn btn-sm btn-outline-primary ms-2" id="nextPage" disabled>ä¸‹ä¸€é¡µ</button>
      </div>
      <div class="text-muted small">
        æ¯é¡µæ˜¾ç¤º 200 æ¡
      </div>
    </div>
  </div>

  <div class="card p-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">ç¿»ç‰Œç»Ÿè®¡</h5>
      <button class="btn btn-info btn-sm" id="showStatsButton" disabled>
        æ˜¾ç¤ºç»Ÿè®¡ï¼ˆè¯·å…ˆè·å–æ•°æ®ï¼‰
      </button>
    </div>
    <div id="statsContainer" style="display: none;">
      <div class="d-flex justify-content-between align-items-center mb-2 result-bar">
        <span id="statsInfo" class="text-muted small"></span>
      </div>
      <div class="table-wrapper">
        <table class="table table-sm mb-0">
          <thead>
          <tr>
            <th style="width: 150px;">æˆå‘˜</th>
            <th style="width: 120px;">ç¿»ç‰Œæ•°é‡</th>
            <th style="width: 120px;">æ€»é¸¡è…¿æ•°</th>
            <th style="width: 120px;">å¹³å‡é¸¡è…¿/æ¡</th>
          </tr>
          </thead>
          <tbody id="statsTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card p-4">
    <h5 class="mb-3">AIèŠå¤© - ä¸å¶åƒå¯¹è¯</h5>
    
    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <label class="form-label">é€‰æ‹©å°å¶åƒ</label>
        <select class="form-control" id="idolSelect">
          <option value="">è¯·å…ˆè·å–ç¿»ç‰Œæ•°æ®</option>
        </select>
      </div>
      <div class="col-md-4 d-flex align-items-end">
        <button class="btn btn-primary" id="startChatButton" disabled>å¼€å§‹èŠå¤©</button>
        <button class="btn btn-outline-secondary ms-2" id="clearChatButton" disabled>æ¸…ç©ºèŠå¤©</button>
      </div>
      <div class="col-md-4 d-flex align-items-center">
        <span class="text-muted small" id="chatStatus">æœªå¼€å§‹èŠå¤©</span>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-4" style="display: none;">
        <label class="form-label mb-1">API Base</label>
        <input type="text" class="form-control" id="apiBaseInput" placeholder="ä¾‹å¦‚ï¼šhttps://api.openai.com">
        <div class="form-text">ä¸éœ€è¦ä»¥ / ç»“å°¾</div>
      </div>
      <div class="col-md-4" style="display: none;">
        <label class="form-label mb-1">API Key</label>
        <input type="password" class="form-control" id="apiKeyInput" placeholder="å¡«å†™ä½ çš„å¯†é’¥">
        <div class="form-text">ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨</div>
      </div>
      <div class="col-md-3">
        <label class="form-label mb-1">æ¨¡å‹åç§°</label>
        <select class="form-control" id="modelInput">
          <optgroup label="ğŸ”¥ æ¨èæ¨¡å‹">
            <option value="MiniMax-Text-01">MiniMax-Text-01</option>
            <option value="DeepSeek-V3.2-Instruct">DeepSeek-V3.2-Instruct</option>
            <option value="Qwen3-235B-A22B-Instruct-2507">Qwen3-235B-A22B-Instruct-2507</option>
          </optgroup>
          <optgroup label="MiniMax ç³»åˆ—">
            <option value="MiniMax-M2">MiniMax-M2</option>
            <option value="MiniMax-M1-80k">MiniMax-M1-80k</option>
          </optgroup>
          <optgroup label="DeepSeek ç³»åˆ—">
            <option value="DeepSeek-V3.1">DeepSeek-V3.1</option>
            <option value="DeepSeek-V3-250324">DeepSeek-V3-250324</option>
          </optgroup>
          <optgroup label="æ™ºè°± GLM ç³»åˆ—">
            <option value="GLM-4.5">GLM-4.5</option>
            <option value="GLM-4-Plus">GLM-4-Plus</option>
            <option value="GLM-4-Air">GLM-4-Air</option>
            <option value="GLM-4.5-Air">GLM-4.5-Air</option>
            <option value="GLM-Z1-AirX">GLM-Z1-AirX</option>
            <option value="GLM-Z1-Flash">GLM-Z1-Flash</option>
            <option value="GLM-4-Flash">GLM-4-Flash</option>
            <option value="GLM-4-FlashX">GLM-4-FlashX</option>
          </optgroup>
          <optgroup label="å…¶ä»–æ¨¡å‹">
            <option value="Kimi-K2">Kimi-K2</option>
            <option value="Baichuan-M2">Baichuan-M2</option>
            <option value="ERNIE-4.5-Turbo-128K">ERNIE-4.5-Turbo-128K</option>
          </optgroup>
          <optgroup label="è‡ªå®šä¹‰">
            <option value="custom">âœï¸ è‡ªå®šä¹‰æ¨¡å‹...</option>
          </optgroup>
        </select>
        <div class="form-text">ğŸ’¡ å¦‚æœä¸€ä¸ªæ¨¡å‹å‡ºé”™ï¼Œå¯ä»¥æ¢å¦å¤–çš„æ¨¡å‹è¯•è¯•</div>
      </div>
      <div class="col-md-1 d-flex align-items-end">
        <button class="btn btn-outline-info w-100" id="testAIButton">æµ‹è¯•</button>
      </div>
    </div>
    <div class="text-muted small mb-3">å¦‚é‡å¹¶å‘é™åˆ¶ï¼Œè¯·ç¨å€™é‡è¯•</div>

    <div class="row g-3 mb-2 align-items-center">
      <div class="col-md-4">
        <label class="form-label mb-1">ç¤ºä¾‹æ¡æ•°ä¸Šé™</label>
        <select class="form-control form-control-sm" id="sampleCountSelect">
          <option value="20" selected>20 æ¡ï¼ˆé»˜è®¤ï¼‰</option>
          <option value="50">50 æ¡</option>
          <option value="100">100 æ¡</option>
        </select>
      </div>
      <div class="col-md-8 d-flex flex-wrap align-items-center gap-2">
        <button class="btn btn-outline-primary btn-sm" id="selectAllSamples" disabled>æœ¬é¡µå…¨é€‰</button>
        <button class="btn btn-outline-secondary btn-sm" id="clearSamplesButton" disabled>æ¸…ç©ºé€‰æ‹©</button>
        <span class="text-muted small" id="sampleHelper">æœªå‹¾é€‰æ—¶é»˜è®¤å–å‰ 20 æ¡æ ·æœ¬ã€‚</span>
      </div>
    </div>

    <div class="mt-2" id="sampleListContainer" style="display: none;">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="text-muted small" id="sampleListInfo"></div>
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-sm btn-outline-primary" id="samplePrevPage" disabled>ä¸Šä¸€é¡µ</button>
          <span class="text-muted small">ç¬¬</span>
          <input type="number" class="form-control form-control-sm" id="samplePageInput" value="1" min="1" style="width: 60px; text-align: center;">
          <span class="text-muted small" id="samplePageInfo">é¡µ</span>
          <button class="btn btn-sm btn-outline-primary" id="sampleNextPage" disabled>ä¸‹ä¸€é¡µ</button>
        </div>
      </div>
      <div class="sample-list" id="sampleList"></div>
    </div>

    <div id="chatContainer" style="display: none;">
      <div class="chat-messages" id="chatMessages">
      </div>
      <div class="chat-input-area mt-3">
        <div class="input-group">
          <input type="text" class="form-control" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." disabled>
          <button class="btn btn-primary" id="sendButton" disabled>å‘é€</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const selectedNickname = document.getElementById("selectedNickname");
  const selectedId        = document.getElementById("selectedId");
  const selectedBalance   = document.getElementById("selectedBalance");
  const refreshBalanceBtn = document.getElementById("refreshBalanceButton");
  const logoutButton      = document.getElementById("logoutButton");

  const smsLoginForm  = document.getElementById("smsLoginForm");
  const areaCodeInput = document.getElementById("areaCodeInput");
  const mobileInput   = document.getElementById("mobileInput");
  const sendCodeButton = document.getElementById("sendCodeButton");
  const verifyCodeSection = document.getElementById("verifyCodeSection");
  const verifyCodeInput = document.getElementById("verifyCodeInput");
  const loginButton = document.getElementById("loginButton");
  const cancelLoginButton = document.getElementById("cancelLoginButton");
  const codeStatus = document.getElementById("codeStatus");

  const getAnswerButton = document.getElementById("getAnswerButton");
  const exportButton    = document.getElementById("exportButton");
  const previewButton   = document.getElementById("previewButton");
  const filterType      = document.getElementById("filterType");
  const filterStatus    = document.getElementById("filterStatus");
  const sortCost        = document.getElementById("sortCost");
  const filterDateStart = document.getElementById("filterDateStart");
  const filterDateEnd   = document.getElementById("filterDateEnd");
  const sortTime        = document.getElementById("sortTime");
  const filterKeyword   = document.getElementById("filterKeyword");
  const filterScopeRadios = document.querySelectorAll("input[name='filterScope']");
  const searchButton    = document.getElementById("searchButton");
  const clearSearchButton = document.getElementById("clearSearchButton");
  const tableBody       = document.getElementById("tableBody");
  const resultCount     = document.getElementById("resultCount");
  const prevPage        = document.getElementById("prevPage");
  const nextPage        = document.getElementById("nextPage");
  const pageInput       = document.getElementById("pageInput");
  const goToPage         = document.getElementById("goToPage");
  const pageInfo        = document.getElementById("pageInfo");
  const paginationInfo  = document.getElementById("paginationInfo");
  const idolSelect      = document.getElementById("idolSelect");
  const startChatButton = document.getElementById("startChatButton");
  const clearChatButton = document.getElementById("clearChatButton");
  const chatContainer   = document.getElementById("chatContainer");
  const chatMessages    = document.getElementById("chatMessages");
  const chatInput       = document.getElementById("chatInput");
  const sendButton      = document.getElementById("sendButton");
  const chatStatus      = document.getElementById("chatStatus");
  const sampleCountSelect   = document.getElementById("sampleCountSelect");
  const sampleListContainer = document.getElementById("sampleListContainer");
  const sampleList          = document.getElementById("sampleList");
  const selectAllSamples    = document.getElementById("selectAllSamples");
  const clearSamplesButton  = document.getElementById("clearSamplesButton");
  const sampleListInfo      = document.getElementById("sampleListInfo");
  const sampleHelper        = document.getElementById("sampleHelper");
  const samplePrevPage      = document.getElementById("samplePrevPage");
  const sampleNextPage      = document.getElementById("sampleNextPage");
  const samplePageInput     = document.getElementById("samplePageInput");
  const samplePageInfo      = document.getElementById("samplePageInfo");
  const apiBaseInput        = document.getElementById("apiBaseInput");
  const apiKeyInput         = document.getElementById("apiKeyInput");
  const modelInput          = document.getElementById("modelInput");
  const testAIButton        = document.getElementById("testAIButton");

  if (modelInput) {
    modelInput.addEventListener("change", function() {
      if (this.value === "custom") {
        const customModel = prompt("è¯·è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°ï¼š", "gpt-3.5-turbo");
        if (customModel && customModel.trim()) {
          const newOption = document.createElement("option");
          newOption.value = customModel.trim();
          newOption.textContent = `âœï¸ ${customModel.trim()} (è‡ªå®šä¹‰)`;
          
          const customGroup = this.querySelector('optgroup[label="è‡ªå®šä¹‰"]');
          if (customGroup) {
            const existingCustom = customGroup.querySelectorAll('option:not([value="custom"])');
            existingCustom.forEach(opt => opt.remove());
            customGroup.insertBefore(newOption, customGroup.querySelector('option[value="custom"]'));
          }
          this.value = customModel.trim();
          localStorage.setItem("ai_model_name", customModel.trim());
        } else {
          this.value = localStorage.getItem("ai_model_name") || "MiniMax-Text-01";
        }
      }
    });
  }

  const showStatsButton = document.getElementById("showStatsButton");
  const statsContainer  = document.getElementById("statsContainer");
  const statsTableBody  = document.getElementById("statsTableBody");
  const statsInfo       = document.getElementById("statsInfo");

  let currentToken   = null;
  let rawAnswerList  = [];
  let viewRows       = [];
  let currentPage    = 1;
  const pageSize     = 200;
  let filteredRows   = [];
  let highlightedRowId = null;
  let selectedIdol   = null;
  let chatHistory    = [];
  let selectedSampleIndexes = new Set();
  const SAMPLE_PAGE_SIZE = 200;
  let currentSamplePage = 1;
  const defaultModel = "gpt-3.5-turbo";
  let lastKeyword    = "";

  function getHeadersBeforeLogin() {
    return {
      "Content-Type": "application/json;charset=utf-8",
      "Accept": "*/*",
      "Accept-Encoding": "gzip, deflate, br",
      "Connection": "keep-alive",
      "pa": "MTcwODkyNDc2MjAwMCw4MTM1LDMwNTk2QTA3NTZBOTNBRjY2MDAxNzkxRDkzREFGOTU1LA==",
      "User-Agent": "PocketFans201807/7.1.10 (iPhone; iOS 16.2; Scale/3.00)",
      "Accept-Language": "zh-Hans-CN;q=1, zh-Hant-TW;q=0.9, ja-CN;q=0.8",
      "appInfo": JSON.stringify({
        "vendor": "huaweiphone",
        "deviceId": "F2BA149C-06DB-9843-31DE-36BF375E36F2",
        "appVersion": "7.1.10",
        "appBuild": "24020203",
        "osVersion": "16.2.0",
        "osType": "ios",
        "deviceName": "My HuaweiPhone",
        "os": "ios"
      })
    };
  }

  function getHeaders(token) {
    return {
      "Content-Type": "application/json;charset=utf-8",
      "Accept": "*/*",
      "Accept-Encoding": "gzip, deflate, br",
      "Connection": "keep-alive",
      "pa": "MTcwODkyNDc2MjAwMCw4MTM1LDMwNTk2QTA3NTZBOTNBRjY2MDAxNzkxRDkzREFGOTU1LA==",
      "User-Agent": "PocketFans201807/7.1.10 (iPhone; iOS 16.2; Scale/3.00)",
      "Accept-Language": "zh-Hans-CN;q=1, zh-Hant-TW;q=0.9, ja-CN;q=0.8",
      "appInfo": JSON.stringify({
        "vendor": "huaweiphone",
        "deviceId": "F2BA149C-06DB-9843-31DE-36BF375E36F2",
        "appVersion": "7.1.10",
        "appBuild": "24020203",
        "osVersion": "16.2.0",
        "osType": "ios",
        "deviceName": "My HuaweiPhone",
        "os": "ios"
      }),
      "token": token
    };
  }

  async function fetchDataBeforeLogin(url, data) {
    if (!url.startsWith("http")) {
      url = "https://api.popcan48.xyz" + (url.startsWith("/") ? url : "/" + url);
    }
    
    const resp = await fetch(url, {
      method: "POST",
      headers: getHeadersBeforeLogin(),
      body: JSON.stringify(data)
    });
    
    const text = await resp.text();
    console.log("ã€APIå“åº”ã€‘", text.slice(0, 500));
    
    let jsonText = text;
    const braceIndex = text.indexOf("{");
    if (braceIndex !== -1) {
      jsonText = text.slice(braceIndex);
    }
    
    try {
      return JSON.parse(jsonText);
    } catch (e) {
      console.error("JSONè§£æå¤±è´¥ï¼ŒåŸå§‹å“åº”:", text.slice(0, 500));
      throw new Error(`å“åº”è§£æå¤±è´¥: ${e.message}`);
    }
  }

  async function fetchData(url, data) {
    if (!currentToken) {
      alert("è¯·å…ˆç™»å½•è´¦å·");
      throw new Error("Not logged in");
    }
    
    if (!url.startsWith("http")) {
      url = "https://api.popcan48.xyz" + (url.startsWith("/") ? url : "/" + url);
    }
    
    const resp = await fetch(url, {
      method: "POST",
      headers: getHeaders(currentToken),
      body: JSON.stringify(data)
    });
    
    const text = await resp.text();
    console.log("ã€APIå“åº”ã€‘", text.slice(0, 500));
    
    if (!resp.ok) {
      console.error("HTTPé”™è¯¯:", resp.status, text);
      throw new Error(`HTTP ${resp.status}: ${text.slice(0, 200)}`);
    }
    
    let jsonText = text;
    const braceIndex = text.indexOf("{");
    const bracketIndex = text.indexOf("[");
    const jsonStartIndex = braceIndex !== -1 && (bracketIndex === -1 || braceIndex < bracketIndex) 
      ? braceIndex 
      : bracketIndex !== -1 ? bracketIndex : -1;
    
    if (jsonStartIndex !== -1) {
      jsonText = text.slice(jsonStartIndex);
    }
    
    try {
      return JSON.parse(jsonText);
    } catch (e) {
      console.error("JSONè§£æå¤±è´¥ï¼ŒåŸå§‹å“åº”:", text.slice(0, 500));
      throw new Error(`å“åº”è§£æå¤±è´¥: ${e.message}\nå“åº”å‰500å­—ç¬¦: ${text.slice(0, 500)}`);
    }
  }

  function loadAIConfig() {
    if (apiBaseInput) {
      apiBaseInput.value = localStorage.getItem("ai_api_base") || "";
    }
    if (apiKeyInput) {
      apiKeyInput.value = localStorage.getItem("ai_api_key") || "";
    }
    if (modelInput) {
      const savedModel = localStorage.getItem("ai_model_name") || defaultModel;
      const modelExists = Array.from(modelInput.options).some(opt => opt.value === savedModel);
      
      if (modelExists) {
        modelInput.value = savedModel;
      } else if (savedModel !== "custom") {
        const customGroup = modelInput.querySelector('optgroup[label="è‡ªå®šä¹‰"]');
        if (customGroup) {
          const newOption = document.createElement("option");
          newOption.value = savedModel;
          newOption.textContent = `âœï¸ ${savedModel} (è‡ªå®šä¹‰)`;
          customGroup.insertBefore(newOption, customGroup.querySelector('option[value="custom"]'));
          modelInput.value = savedModel;
        }
      } else {
        modelInput.value = "MiniMax-Text-01";
      }
    }
  }

  function saveAIConfig() {
    if (apiBaseInput) {
      localStorage.setItem("ai_api_base", apiBaseInput.value.trim());
    }
    if (apiKeyInput) {
      localStorage.setItem("ai_api_key", apiKeyInput.value.trim());
    }
    if (modelInput) {
      localStorage.setItem("ai_model_name", modelInput.value.trim() || defaultModel);
    }
  }

  function getAIConfig() {
    const workerUrl = "https://ai.popcan48.xyz";
    const modelName = (modelInput?.value || "").trim() || defaultModel;

    if (!modelName) throw new Error("æ¨¡å‹åç§°æœªé…ç½®");

    const apiBase = workerUrl.replace(/\/+$/, "");
    console.log("AI Worker URL:", apiBase);
    console.log("Selected Model:", modelName);

    return {
      apiBase: apiBase,
      apiKey: "",
      modelName
    };
  }

  function updateAccountHeader(info) {
    if (!info) {
      currentToken = null;
      selectedNickname.textContent = "æœªç™»å½•";
      selectedId.textContent        = "";
      selectedBalance.textContent   = "--";
      return;
    }
    currentToken = info.token;
    selectedNickname.textContent = info.nickname || "å·²ç™»å½•";
    selectedId.textContent       = info.id ? `(ID: ${info.id})` : "";
    selectedBalance.textContent  = info.balance != null ? info.balance : "--";
  }

  function mapAnswerToRow(answer) {
    let typeLabel = "æ–‡å­—";
    if (answer.answerType === 2) typeLabel = "è¯­éŸ³";
    if (answer.answerType === 3) typeLabel = "è§†é¢‘";

    const memberName =
      (answer.baseUserInfo && (answer.baseUserInfo.nickname || answer.baseUserInfo.starName)) ||
      "";

    const questionContent = answer.content || "";
    
    let answerContent = "";
    let mediaUrl = "";
    if (answer.status === 2) {
      if (answer.answerType === 1) {
        answerContent = answer.answerContent || "";
      } else {
        try {
          const obj = JSON.parse(answer.answerContent || "{}");
          const url = obj.url || "";
          mediaUrl = url;
          answerContent =
            (answer.answerType === 2 ? "[è¯­éŸ³] " : "[è§†é¢‘] ") +
            (url || "");
        } catch (e) {
          answerContent = "[å¤šåª’ä½“ç¿»ç‰Œ]ï¼ˆå†…å®¹è§£æå¤±è´¥ï¼‰";
        }
      }
    } else {
      answerContent = "ã€æœªç¿» / å·²é€€æ¬¾ã€‘";
    }

    const qtime = answer.qtime ? parseInt(answer.qtime, 10) : Date.now();
    const answerTime = answer.answerTime ? parseInt(answer.answerTime, 10) : null;
    const questionDate = new Date(qtime);
    const answerDate = answerTime ? new Date(answerTime) : null;

    const cost = answer.cost || answer.price || 0;

    return {
      id: answer.questionId || Date.now() + Math.random(),
      type: typeLabel,
      answerType: answer.answerType || 1,
      member: memberName,
      questionContent: questionContent,
      answerContent: answerContent,
      questionTime: qtime,
      answerTime: answerTime,
      questionDate: questionDate.toISOString().slice(0, 10),
      answerDate: answerDate ? answerDate.toISOString().slice(0, 10) : "",
      questionDateTime: questionDate.toLocaleString("zh-CN"),
      answerDateTime: answerDate ? answerDate.toLocaleString("zh-CN") : "",
      cost: parseFloat(cost) || 0,
      status: answer.status || 0,
      raw: answer,
      mediaUrl
    };
  }

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, (s) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;"
    })[s]);
  }

  function renderTable(rows, page = 1) {
    tableBody.innerHTML = "";
    
    if (!rows.length) {
      tableBody.innerHTML =
        '<tr><td colspan="6" class="text-center text-muted py-4">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ•°æ®</td></tr>';
      resultCount.textContent = "";
      paginationInfo.textContent = "";
      return;
    }

    const totalPages = Math.ceil(rows.length / pageSize);
    const startIndex = (page - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, rows.length);
    const pageRows = rows.slice(startIndex, endIndex);
    const scope = getKeywordScope();
    const fragment = document.createDocumentFragment();

    pageRows.forEach((item) => {
      const badge =
        item.type === "æ–‡å­—"
          ? '<span class="badge-text">æ–‡å­—</span>'
          : '<span class="badge-audio">' + item.type + "</span>";
      const kw = lastKeyword;
      const highlightQuestion = scope !== "answer";
      const highlightAnswer = scope !== "question";
      const tr = document.createElement("tr");
      tr.id = `row-${item.id}`;
      if (highlightedRowId === item.id) {
        tr.classList.add("highlight-row");
      }
      tr.style.cursor = "pointer";
      tr.addEventListener("click", (e) => {
        if (e.target.tagName === "A" || e.target.tagName === "BUTTON" || 
            e.target.closest("audio") || e.target.closest("video") ||
            e.target.closest("a") || e.target.closest("button")) {
          return;
        }
        jumpToRowInFullList(item.id);
      });
      tr.title = "ç‚¹å‡»è·³è½¬åˆ°å®Œæ•´åˆ—è¡¨ä¸­çš„ä½ç½®";
      tr.innerHTML = `
        <td>${badge}</td>
        <td class="fw-bold">${escapeHtml(item.member)}</td>
        <td class="text-muted small">${item.questionDateTime}</td>
        <td class="question-content">${highlightQuestion ? highlightText(item.questionContent, kw) : escapeHtml(item.questionContent)}</td>
        <td class="answer-content">
          ${highlightAnswer ? highlightText(item.answerContent, kw) : escapeHtml(item.answerContent)}
          ${renderMedia(item)}
        </td>
        <td class="text-danger fw-bold">${item.cost.toFixed(2)}</td>
      `;
      fragment.appendChild(tr);
    });
    
    tableBody.appendChild(fragment);

    resultCount.textContent = `å…± ${rows.length} æ¡ç»“æœ`;
    paginationInfo.textContent = `æ˜¾ç¤ºç¬¬ ${startIndex + 1}-${endIndex} æ¡`;
    pageInfo.textContent = `é¡µï¼Œå…± ${totalPages} é¡µ`;
    
    const pageInput = document.getElementById("pageInput");
    if (pageInput) {
      pageInput.value = page;
      pageInput.max = totalPages;
    }
    
    prevPage.disabled = page <= 1;
    nextPage.disabled = page >= totalPages;
    
    currentPage = page;
    filteredRows = rows;
  }

  function updateStatusFilterCounts() {
    if (!filterStatus || !rawAnswerList.length) return;
    
    const answeredCount = rawAnswerList.filter(a => a.status === 2).length;
    const returnedCount = rawAnswerList.filter(a => a.status !== 2).length;
    const totalCount = rawAnswerList.length;
    
    const allOption = filterStatus.querySelector('option[value=""]');
    const answeredOption = filterStatus.querySelector('option[value="answered"]');
    const returnedOption = filterStatus.querySelector('option[value="returned"]');
    
    if (allOption) allOption.textContent = `å…¨éƒ¨ (${totalCount})`;
    if (answeredOption) answeredOption.textContent = `å·²ç¿» (${answeredCount})`;
    if (returnedOption) returnedOption.textContent = `é€€å› (${returnedCount})`;
  }

  function applyFilter() {
    if (!rawAnswerList.length) {
      renderTable([], 1);
      return;
    }

    const typeVal = filterType.value;
    const statusVal = filterStatus ? filterStatus.value : "";
    const costSort = sortCost.value;
    const dateStart = filterDateStart.value;
    const dateEnd = filterDateEnd.value;
    const timeSort = sortTime.value;
    const kw = filterKeyword.value.trim().toLowerCase();
    lastKeyword = kw;
    
    if (clearSearchButton) {
      clearSearchButton.style.display = kw ? "inline-block" : "none";
    }

    let sourceRows = [];
    if (statusVal === "answered") {
      sourceRows = viewRows;
    } else if (statusVal === "returned") {
      sourceRows = rawAnswerList
        .filter(a => a.status !== 2)
        .map(mapAnswerToRow);
    } else {
      sourceRows = rawAnswerList.map(mapAnswerToRow);
    }

    if (!sourceRows.length) {
      renderTable([], 1);
      return;
    }

    const scope = getKeywordScope();
    let filtered = sourceRows.filter((row) => {
      let ok = true;

      if (typeVal) {
        ok = ok && (row.answerType.toString() === typeVal);
      }

      if (dateStart) {
        ok = ok && (row.questionDate >= dateStart);
      }

      if (dateEnd) {
        ok = ok && (row.questionDate <= dateEnd);
      }

      if (kw) {
        ok = ok && matchesKeyword(row, kw, scope);
      }

      return ok;
    });

    if (costSort === "desc") {
      filtered.sort((a, b) => b.cost - a.cost);
    } else if (costSort === "asc") {
      filtered.sort((a, b) => a.cost - b.cost);
    }

    if (timeSort === "asc") {
      filtered.sort((a, b) => {
        const timeA = a.answerTime || a.questionTime;
        const timeB = b.answerTime || b.questionTime;
        return timeA - timeB;
      });
    } else if (timeSort === "desc") {
      filtered.sort((a, b) => {
        const timeA = a.answerTime || a.questionTime;
        const timeB = b.answerTime || b.questionTime;
        return timeB - timeA;
      });
    }

    currentPage = 1;
    renderTable(filtered, 1);
  }

  function getKeywordScope() {
    const checked = Array.from(filterScopeRadios || []).find((r) => r.checked);
    return checked ? checked.value : "all";
  }

  function matchesKeyword(row, kw, scope) {
    if (!kw) return true;
    const q = (row.questionContent || "").toLowerCase();
    const a = (row.answerContent || "").toLowerCase();
    if (scope === "question") {
      return q.includes(kw);
    }
    if (scope === "answer") {
      return a.includes(kw);
    }
    return q.includes(kw) || a.includes(kw);
  }

  function escapeRegex(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
  }

  function highlightText(text, kw) {
    const source = String(text || "");
    if (!kw) return escapeHtml(source);
    const regex = new RegExp(escapeRegex(kw), "gi");
    let lastIndex = 0;
    let result = "";
    let match;
    while ((match = regex.exec(source)) !== null) {
      result += escapeHtml(source.slice(lastIndex, match.index));
      result += `<span class="kw-highlight">${escapeHtml(match[0])}</span>`;
      lastIndex = match.index + match[0].length;
    }
    result += escapeHtml(source.slice(lastIndex));
    return result;
  }

  function buildMediaUrl(url) {
    if (!url) return "";
    
    if (url.startsWith("http://") || url.startsWith("https://")) {
      return url;
    }
    
    if (url.startsWith("/")) {
      return "https://pocketapi.48.cn" + url;
    }
    
    try {
      const u = new URL(url, "https://pocketapi.48.cn");
      return u.href;
    } catch (e) {
      return "";
    }
  }

  function sanitizeUrl(url) {
    if (!url) return "";
    const fullUrl = buildMediaUrl(url);
    try {
      const u = new URL(fullUrl);
      if (u.protocol === "http:" || u.protocol === "https:") {
        return u.href;
      }
    } catch (e) {
      return "";
    }
    return "";
  }

  function getMediaType(url) {
    if (!url) return "";
    const lower = url.toLowerCase();
    if (lower.includes('.mp3') || lower.includes('.m4a')) return 'audio/mpeg';
    if (lower.includes('.wav')) return 'audio/wav';
    if (lower.includes('.ogg')) return 'audio/ogg';
    if (lower.includes('.mp4')) return 'video/mp4';
    if (lower.includes('.webm')) return 'video/webm';
    if (lower.includes('.ogg') || lower.includes('.ogv')) return 'video/ogg';
    return "";
  }

  function renderMedia(item) {
    const url = sanitizeUrl(item.mediaUrl);
    if (!url) return "";

    const mediaType = getMediaType(url);

    if (item.answerType === 2) {
      return `
        <div style="margin-top: 8px;">
          <audio controls preload="metadata" style="max-width: 100%; vertical-align: middle;">
            <source src="${url}" ${mediaType ? `type="${mediaType}"` : ''}>
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
          </audio>
          <br>
          <a href="${url}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-secondary mt-1">åœ¨æ–°çª—å£æ‰“å¼€</a>
        </div>
      `;
    }

    if (item.answerType === 3) {
      return `
        <div style="margin-top: 8px;">
          <video controls preload="metadata" style="max-width: 100%; max-height: 240px; vertical-align: middle;">
            <source src="${url}" ${mediaType ? `type="${mediaType}"` : ''}>
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
          </video>
          <br>
          <a href="${url}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-secondary mt-1">åœ¨æ–°çª—å£æ‰“å¼€</a>
        </div>
      `;
    }

    return `<a class="btn btn-sm btn-outline-primary ms-2" href="${url}" target="_blank" rel="noopener">æ‰“å¼€å†…å®¹</a>`;
  }

  function jumpToRowInFullList(rowId) {
    if (!rawAnswerList.length) {
      alert("è¯·å…ˆè·å–ç¿»ç‰Œæ•°æ®");
      return;
    }

    const allRows = rawAnswerList.map(mapAnswerToRow);
    const targetIndex = allRows.findIndex(row => row.id === rowId);
    
    if (targetIndex === -1) {
      alert("æœªæ‰¾åˆ°è¯¥ç¿»ç‰Œ");
      return;
    }

    const savedKeyword = filterKeyword.value.trim();
    filterType.value = "";
    if (filterStatus) filterStatus.value = "";
    filterDateStart.value = "";
    filterDateEnd.value = "";
    sortCost.value = "";
    sortTime.value = "";
    
    highlightedRowId = rowId;
    filteredRows = allRows;
    const targetPage = Math.floor(targetIndex / pageSize) + 1;
    renderTable(allRows, targetPage);
    lastKeyword = savedKeyword.toLowerCase();
    
    setTimeout(() => {
      const rowElement = document.getElementById(`row-${rowId}`);
      if (rowElement) {
        rowElement.scrollIntoView({ behavior: "smooth", block: "center" });
        rowElement.classList.add("highlight-row");
        setTimeout(() => {
          rowElement.classList.remove("highlight-row");
        }, 3000);
      }
    }, 100);
  }

  function searchAndLocate() {
    const kw = filterKeyword.value.trim().toLowerCase();
    lastKeyword = kw;
    
    if (!kw) {
      applyFilter();
      if (clearSearchButton) clearSearchButton.style.display = "none";
      return;
    }

    if (clearSearchButton) clearSearchButton.style.display = "inline-block";
    applyFilter();
  }

  if (smsLoginForm) {
    smsLoginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (sendCodeButton) {
        sendCodeButton.click();
      }
    });
  }

  if (sendCodeButton) {
    sendCodeButton.addEventListener("click", async () => {
      const area = (areaCodeInput.value || "86").trim();
      const mobile = mobileInput.value.trim();

      if (!mobile) {
        alert("è¯·è¾“å…¥æ‰‹æœºå·");
        return;
      }

      sendCodeButton.disabled = true;
      sendCodeButton.textContent = "å‘é€ä¸­...";
      if (codeStatus) codeStatus.textContent = "";

      try {
        const resp = await fetchDataBeforeLogin("/user/api/v1/sms/send2", {
          mobile: mobile,
          area: area
        });
        if (resp.status !== 200 || resp.success === false) {
          const errorMsg = resp.message || resp.msg || "æœªçŸ¥é”™è¯¯";
          alert("å‘é€éªŒè¯ç å¤±è´¥: " + errorMsg + "\nçŠ¶æ€ç : " + (resp.status || "æœªçŸ¥"));
          sendCodeButton.disabled = false;
          sendCodeButton.textContent = "å‘é€éªŒè¯ç ";
          return;
        } else {
          console.log("éªŒè¯ç å‘é€æˆåŠŸ");
          if (cancelLoginButton) cancelLoginButton.style.display = "block";
          if (codeStatus) codeStatus.textContent = "âœ“ éªŒè¯ç å·²å‘é€ï¼Œè¯·æŸ¥çœ‹çŸ­ä¿¡å¹¶è¾“å…¥éªŒè¯ç ";
          if (verifyCodeInput) {
            verifyCodeInput.value = "";
            verifyCodeInput.disabled = false;
            verifyCodeInput.focus();
          }
          if (loginButton) loginButton.disabled = false;
          if (mobileInput) mobileInput.disabled = true;
          if (areaCodeInput) areaCodeInput.disabled = true;
        }
      } catch (err) {
        console.error("å‘é€éªŒè¯ç è¯·æ±‚å¼‚å¸¸:", err);
        alert("å‘é€éªŒè¯ç è¯·æ±‚å¤±è´¥ï¼š" + err.message + "\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯ã€‚");
      } finally {
        sendCodeButton.disabled = false;
        sendCodeButton.textContent = "å‘é€éªŒè¯ç ";
      }
    });
  }

  if (cancelLoginButton) {
    cancelLoginButton.addEventListener("click", () => {
      cancelLoginButton.style.display = "none";
      if (verifyCodeInput) {
        verifyCodeInput.value = "";
        verifyCodeInput.disabled = true;
      }
      if (loginButton) loginButton.disabled = true;
      if (codeStatus) codeStatus.textContent = "è¯·å…ˆå‘é€éªŒè¯ç ";
      if (mobileInput) mobileInput.disabled = false;
      if (areaCodeInput) areaCodeInput.disabled = false;
    });
  }

  if (loginButton) {
    loginButton.addEventListener("click", async () => {
      const area = (areaCodeInput.value || "86").trim();
      const mobile = mobileInput.value.trim();
      const code = verifyCodeInput.value.trim();

      if (!mobile) {
        alert("è¯·è¾“å…¥æ‰‹æœºå·");
        return;
      }

      if (!code) {
        alert("è¯·è¾“å…¥éªŒè¯ç ");
        if (verifyCodeInput) verifyCodeInput.focus();
        return;
      }

      loginButton.disabled = true;
      loginButton.textContent = "ç™»å½•ä¸­...";
      if (codeStatus) codeStatus.textContent = "æ­£åœ¨ç™»å½•...";

      try {
        const loginResp = await fetchDataBeforeLogin("/user/api/v1/login/app/mobile/code", {
          mobile: mobile,
          code: code
        });

        const content = loginResp.content || {};
        const userInfo = content.userInfo || {};

        const info = {
          token: content.token,
          nickname: userInfo.nickname,
          id: userInfo.userId,
          balance: userInfo.money
        };

        updateAccountHeader(info);
        
        if (cancelLoginButton) cancelLoginButton.style.display = "none";
        if (verifyCodeInput) {
          verifyCodeInput.value = "";
          verifyCodeInput.disabled = true;
        }
        if (loginButton) loginButton.disabled = true;
        if (codeStatus) codeStatus.textContent = "è¯·å…ˆå‘é€éªŒè¯ç ";
        if (mobileInput) mobileInput.disabled = false;
        if (areaCodeInput) areaCodeInput.disabled = false;
        
        alert("ç™»å½•æˆåŠŸï¼");
      } catch (err) {
        console.error(err);
        alert("ç™»å½•è¯·æ±‚å¤±è´¥ï¼š" + err.message);
        if (codeStatus) codeStatus.textContent = "ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•";
      } finally {
        loginButton.disabled = false;
        loginButton.textContent = "ç¡®è®¤ç™»å½•";
      }
    });
  }

  if (verifyCodeInput) {
    verifyCodeInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        if (loginButton) loginButton.click();
      }
    });
  }


  if (refreshBalanceBtn) {
    refreshBalanceBtn.addEventListener("click", async () => {
      if (!currentToken) {
        alert("è¯·å…ˆç™»å½•è´¦å·");
        return;
      }
      try {
        const resp = await fetchData(
          "/user/api/v1/user/money",
          { token: currentToken }
        );
        if (resp.status === 200) {
          const money = resp.content && resp.content.moneyTotal;
          selectedBalance.textContent =
            money != null ? money : selectedBalance.textContent;
          alert("ä½™é¢å·²åˆ·æ–°");
        } else {
          alert("åˆ·æ–°ä½™é¢å¤±è´¥: " + resp.message);
        }
      } catch (e) {
        console.error(e);
        alert("åˆ·æ–°ä½™é¢æ—¶å‡ºé”™");
      }
    });
  }

  if (logoutButton) {
    logoutButton.addEventListener("click", async () => {
      if (!currentToken) {
        alert("å½“å‰æœªç™»å½•");
        return;
      }
      try {
        const resp = await fetchData(
          "/user/api/v1/logout/user",
          {}
        );
        if (resp.status === 200 || resp.status === 401004) {
          updateAccountHeader(null);
          currentToken = null;
          rawAnswerList = [];
          viewRows = [];
          filteredRows = [];
          currentPage = 1;
          highlightedRowId = null;
          renderTable([], 1);
          if (statsContainer) statsContainer.style.display = "none";
          if (showStatsButton) {
            showStatsButton.textContent = "æ˜¾ç¤ºç»Ÿè®¡ï¼ˆè¯·å…ˆè·å–æ•°æ®ï¼‰";
            showStatsButton.disabled = true;
          }
          filterKeyword.value = "";
          filterType.value = "";
          sortCost.value = "";
          filterDateStart.value = "";
          filterDateEnd.value = "";
          sortTime.value = "";
          
          if (chatContainer) chatContainer.style.display = "none";
          if (idolSelect) idolSelect.innerHTML = '<option value="">è¯·å…ˆè·å–ç¿»ç‰Œæ•°æ®</option>';
          if (startChatButton) startChatButton.disabled = true;
          if (clearChatButton) clearChatButton.disabled = true;
          if (chatStatus) chatStatus.textContent = "æœªå¼€å§‹èŠå¤©";
          if (sampleListContainer) sampleListContainer.style.display = "none";
          selectedSampleIndexes = new Set();
          updateSampleHelper();
          selectedIdol = null;
          chatHistory = [];
          
          alert("å·²é€€å‡ºç™»å½•");
        } else {
          alert("é€€å‡ºç™»å½•å¤±è´¥: " + resp.message);
        }
      } catch (e) {
        console.error(e);
        alert("é€€å‡ºç™»å½•æ—¶å‡ºé”™");
      }
    });
  }

  if (getAnswerButton) {
    getAnswerButton.addEventListener("click", async () => {
      if (!currentToken) {
        alert("è¯·å…ˆç™»å½•è´¦å·");
        return;
      }

      const maxRecords = parseInt(maxRecordsSelect?.value || "10000");
      
      if (maxRecords > 10000 || maxRecords === -1) {
        if (!confirm(`ä½ é€‰æ‹©äº†è·å–${maxRecords === -1 ? 'å…¨éƒ¨' : maxRecords}æ¡æ•°æ®ã€‚\n\næ•°æ®é‡è¿‡å¤§å¯èƒ½å¯¼è‡´æµè§ˆå™¨å¡é¡¿æˆ–å´©æºƒã€‚\n\nå»ºè®®ï¼š\n- é¦–æ¬¡ä½¿ç”¨é€‰æ‹©è¾ƒå°çš„æ•°é‡\n- ç¡®ä¿æµè§ˆå™¨æœ‰è¶³å¤Ÿå†…å­˜\n\næ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
          return;
        }
      }

      getAnswerButton.disabled = true;
      if (maxRecordsSelect) maxRecordsSelect.disabled = true;
      const originalText = getAnswerButton.textContent;
      getAnswerButton.textContent = "æ­£åœ¨è·å–...";
      
      if (loadingProgress) loadingProgress.style.display = "block";

      try {
        let all = [];
        let beginLimit = 0;
        let size = 20;
        let pageCount = 0;
        const estimatedTotal = maxRecords === -1 ? 20000 : maxRecords;

        while (size > 0) {
          if (maxRecords !== -1 && all.length >= maxRecords) {
            console.log(`å·²è¾¾åˆ°è®¾ç½®çš„æœ€å¤§æ¡æ•°é™åˆ¶ï¼š${maxRecords}`);
            break;
          }

          pageCount++;
          const progress = maxRecords === -1 ? 
            Math.min(95, (all.length / estimatedTotal) * 100) : 
            Math.min(95, (all.length / maxRecords) * 100);
          
          getAnswerButton.textContent = `æ­£åœ¨è·å–... (ç¬¬${pageCount}é¡µï¼Œå·²è·å–${all.length}æ¡)`;
          if (loadingProgressBar) {
            loadingProgressBar.style.width = progress + "%";
          }
          if (loadingProgressText) {
            loadingProgressText.textContent = `${Math.round(progress)}% (${all.length}æ¡)`;
          }

          const resp = await fetchData(
            "/idolanswer/api/idolanswer/v1/user/question/list",
            {
              status: 0,
              beginLimit: beginLimit,
              memberId: "",
              limit: 20
            }
          );

          if (resp.status !== 200) {
            const errorMsg = resp.message || resp.msg || "æœªçŸ¥é”™è¯¯";
            alert(`è·å–ç¿»ç‰Œæ•°æ®å¤±è´¥ (ç¬¬${pageCount}é¡µ): ${errorMsg}\nçŠ¶æ€ç : ${resp.status}`);
            console.error("APIå“åº”:", resp);
            break;
          }

          const list = resp.content || [];
          if (!Array.isArray(list)) {
            console.error("å“åº”æ ¼å¼é”™è¯¯ï¼Œcontentä¸æ˜¯æ•°ç»„:", resp);
            alert(`å“åº”æ ¼å¼é”™è¯¯ï¼šcontentå­—æ®µä¸æ˜¯æ•°ç»„ã€‚è¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯ã€‚`);
            break;
          }

          // ä½¿ç”¨ push.apply ä»£æ›¿ concatï¼Œå‡å°‘å†…å­˜åˆ†é…
          all.push(...list);
          size = list.length;
          beginLimit += 20;

          if (size === 0) {
            break;
          }

          if (pageCount % 100 === 0) {
            await new Promise(resolve => setTimeout(resolve, 200));
          } else {
            await new Promise(resolve => setTimeout(resolve, 50));
          }
        }

        getAnswerButton.textContent = "æ­£åœ¨å¤„ç†æ•°æ®...";
        if (loadingProgressBar) loadingProgressBar.style.width = "95%";
        if (loadingProgressText) loadingProgressText.textContent = "95% (å¤„ç†ä¸­)";

        rawAnswerList = all;
        
        const answered = [];
        const batchSize = 500;
        for (let i = 0; i < all.length; i += batchSize) {
          const batch = all.slice(i, Math.min(i + batchSize, all.length));
          answered.push(...batch.filter(a => a.status === 2));
          
          if (i % 1000 === 0) {
            await new Promise(resolve => setTimeout(resolve, 10));
          }
        }
        
        viewRows = answered.map(mapAnswerToRow);

        if (all.length > 0) {
          console.log("ã€ç¿»ç‰Œæ•°æ®ç»“æ„ç¤ºä¾‹ã€‘", all[0]);
        }

        if (!viewRows.length) {
          alert("æ²¡æœ‰å·²ç¿»çš„ç¿»ç‰Œè®°å½•ï¼ˆstatus=2ï¼‰");
        }

        getAnswerButton.textContent = "æ­£åœ¨æ›´æ–°ç•Œé¢...";
        if (loadingProgressBar) loadingProgressBar.style.width = "98%";
        if (loadingProgressText) loadingProgressText.textContent = "98% (æ›´æ–°ç•Œé¢)";

        updateStatusFilterCounts();
        currentPage = 1;
        
        await new Promise(resolve => setTimeout(resolve, 10));
        applyFilter();
        
        if (all.length > 0 && showStatsButton) {
          showStatsButton.textContent = "æ˜¾ç¤ºç»Ÿè®¡";
          showStatsButton.disabled = false;
        }

        updateIdolSelect();
        
        if (loadingProgressBar) loadingProgressBar.style.width = "100%";
        if (loadingProgressText) loadingProgressText.textContent = "100% (å®Œæˆ)";
        
        setTimeout(() => {
          if (loadingProgress) loadingProgress.style.display = "none";
          alert(`è·å–å®Œæˆï¼å…±è·å– ${all.length} æ¡è®°å½•ï¼Œå…¶ä¸­å·²ç¿» ${viewRows.length} æ¡`);
        }, 500);
        
      } catch (e) {
        console.error("è·å–ç¿»ç‰Œæ•°æ®æ—¶å‡ºé”™:", e);
        const errorMsg = e.message || e.toString();
        alert(`è·å–ç¿»ç‰Œæ•°æ®æ—¶å‡ºé”™ï¼š\n${errorMsg}\n\nè¯·æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚`);
        if (loadingProgress) loadingProgress.style.display = "none";
      } finally {
        getAnswerButton.disabled = false;
        if (maxRecordsSelect) maxRecordsSelect.disabled = false;
        getAnswerButton.textContent = "è·å– / åˆ·æ–°æˆ‘çš„ç¿»ç‰Œæ•°æ®";
      }
    });
  }

  function getSampleLimit() {
    const val = sampleCountSelect ? parseInt(sampleCountSelect.value, 10) : 20;
    return Number.isFinite(val) && val > 0 ? val : 20;
  }

  function updateSampleHelper() {
    const limit = getSampleLimit();
    const selectedCount = selectedSampleIndexes.size;
    if (sampleHelper) {
      sampleHelper.textContent = selectedCount > 0
        ? `å·²é€‰ ${selectedCount} æ¡ï¼Œå°†æŒ‰ä¸Šé™ ${limit} æ¡ä¼ ç»™å¤§æ¨¡å‹ï¼ˆè¶…è¿‡ä¸Šé™ä¼šè‡ªåŠ¨æˆªæ–­ï¼‰ã€‚`
        : `æœªå‹¾é€‰æ—¶é»˜è®¤å–å‰ ${limit} æ¡æ ·æœ¬ã€‚`;
    }
    if (clearSamplesButton) {
      clearSamplesButton.disabled = selectedCount === 0;
    }
    if (selectAllSamples) {
      selectAllSamples.disabled = !selectedIdol;
    }
  }

  function renderSampleList(page = 1) {
    if (!sampleListContainer || !sampleList) return;

    if (!selectedIdol || !selectedIdol.answers || selectedIdol.answers.length === 0) {
      sampleListContainer.style.display = "none";
      sampleList.innerHTML = "";
      selectedSampleIndexes = new Set();
      updateSampleHelper();
      return;
    }

    const totalAnswers = selectedIdol.answers.length;
    const totalPages = Math.ceil(totalAnswers / SAMPLE_PAGE_SIZE);
    currentSamplePage = Math.max(1, Math.min(page, totalPages));

    const startIndex = (currentSamplePage - 1) * SAMPLE_PAGE_SIZE;
    const endIndex = Math.min(startIndex + SAMPLE_PAGE_SIZE, totalAnswers);
    const pageAnswers = selectedIdol.answers.slice(startIndex, endIndex);

    sampleListContainer.style.display = "block";
    if (sampleListInfo) {
      sampleListInfo.textContent = `å…± ${totalAnswers} æ¡ç¿»ç‰Œï¼Œæ˜¾ç¤ºç¬¬ ${startIndex + 1}-${endIndex} æ¡`;
    }

    if (samplePageInput) {
      samplePageInput.value = currentSamplePage;
      samplePageInput.max = totalPages;
    }
    if (samplePageInfo) {
      samplePageInfo.textContent = `é¡µï¼Œå…± ${totalPages} é¡µ`;
    }
    if (samplePrevPage) {
      samplePrevPage.disabled = currentSamplePage <= 1;
    }
    if (sampleNextPage) {
      sampleNextPage.disabled = currentSamplePage >= totalPages;
    }

    sampleList.innerHTML = "";
    const frag = document.createDocumentFragment();

    pageAnswers.forEach((item, localIndex) => {
      const globalIndex = startIndex + localIndex;
      const label = document.createElement("label");
      label.className = "sample-item";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.className = "form-check-input mt-1";
      checkbox.checked = selectedSampleIndexes.has(globalIndex);
      checkbox.addEventListener("change", (e) => {
        if (e.target.checked) {
          selectedSampleIndexes.add(globalIndex);
        } else {
          selectedSampleIndexes.delete(globalIndex);
        }
        updateSampleHelper();
      });

      const textWrapper = document.createElement("div");
      textWrapper.className = "sample-text";

      const meta = document.createElement("div");
      meta.className = "sample-meta";
      const timeLabel = item.time ? new Date(item.time).toLocaleDateString("zh-CN") : "æ—¶é—´æœªçŸ¥";
      meta.textContent = `ç¤ºä¾‹ ${globalIndex + 1} Â· ${timeLabel}`;

      const questionDiv = document.createElement("div");
      questionDiv.innerHTML = `<span class="sample-badge">Q</span>${escapeHtml(item.question || "")}`;

      const answerDiv = document.createElement("div");
      answerDiv.innerHTML = `<span class="sample-badge">A</span>${escapeHtml(item.answer || "")}`;

      textWrapper.appendChild(meta);
      textWrapper.appendChild(questionDiv);
      textWrapper.appendChild(answerDiv);

      label.appendChild(checkbox);
      label.appendChild(textWrapper);
      frag.appendChild(label);
    });

    sampleList.appendChild(frag);
    updateSampleHelper();
  }

  function getExamplesForPrompt(idol) {
    if (!idol || !idol.answers) return [];
    const limit = getSampleLimit();

    if (selectedSampleIndexes.size > 0) {
      const indexes = Array.from(selectedSampleIndexes).sort((a, b) => a - b);
      const picked = indexes
        .filter(idx => idx >= 0 && idx < idol.answers.length)
        .map((idx) => idol.answers[idx])
        .filter(Boolean);
      return picked.slice(0, limit);
    }

    return idol.answers.slice(0, limit);
  }

  function updateIdolSelect() {
    if (!idolSelect) return;
    
    const idols = new Map();
    rawAnswerList.forEach((answer) => {
      const memberName = (answer.baseUserInfo && (answer.baseUserInfo.nickname || answer.baseUserInfo.starName)) || "";
      if (memberName && answer.status === 2 && answer.answerContent) {
        if (!idols.has(memberName)) {
          idols.set(memberName, {
            name: memberName,
            answers: []
          });
        }
        idols.get(memberName).answers.push({
          question: answer.content || "",
          answer: answer.answerType === 1 ? answer.answerContent : "[å¤šåª’ä½“ç¿»ç‰Œ]",
          time: answer.answerTime || answer.qtime
        });
      }
    });

    idolSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å°å¶åƒ</option>';
    idols.forEach((idol, name) => {
      const option = document.createElement("option");
      option.value = name;
      option.textContent = `${name} (${idol.answers.length}æ¡ç¿»ç‰Œ)`;
      idolSelect.appendChild(option);
    });

    if (idols.size > 0) {
      startChatButton.disabled = false;
    } else {
      startChatButton.disabled = true;
    }

    selectedIdol = null;
    selectedSampleIndexes = new Set();
    currentSamplePage = 1;
    renderSampleList(1);
    updateSampleHelper();
  }

  if (idolSelect) {
    idolSelect.addEventListener("change", (e) => {
      if (e.target.value) {
        const idols = new Map();
        rawAnswerList.forEach((answer) => {
          const memberName = (answer.baseUserInfo && (answer.baseUserInfo.nickname || answer.baseUserInfo.starName)) || "";
          if (memberName === e.target.value && answer.status === 2 && answer.answerContent) {
            if (!idols.has(memberName)) {
              idols.set(memberName, {
                name: memberName,
                answers: []
              });
            }
            idols.get(memberName).answers.push({
              question: answer.content || "",
              answer: answer.answerType === 1 ? answer.answerContent : "[å¤šåª’ä½“ç¿»ç‰Œ]",
              time: answer.answerTime || answer.qtime
            });
          }
        });
        selectedIdol = idols.get(e.target.value);
        selectedSampleIndexes = new Set();
        currentSamplePage = 1;
        renderSampleList(1);
        updateSampleHelper();
      } else {
        selectedIdol = null;
        selectedSampleIndexes = new Set();
        currentSamplePage = 1;
        renderSampleList(1);
        updateSampleHelper();
      }
    });
  }

  if (sampleCountSelect) {
    sampleCountSelect.addEventListener("change", () => {
      renderSampleList(currentSamplePage);
      updateSampleHelper();
    });
  }

  if (samplePrevPage) {
    samplePrevPage.addEventListener("click", () => {
      if (currentSamplePage > 1) {
        renderSampleList(currentSamplePage - 1);
      }
    });
  }

  if (sampleNextPage) {
    sampleNextPage.addEventListener("click", () => {
      if (selectedIdol && selectedIdol.answers) {
        const totalPages = Math.ceil(selectedIdol.answers.length / SAMPLE_PAGE_SIZE);
        if (currentSamplePage < totalPages) {
          renderSampleList(currentSamplePage + 1);
        }
      }
    });
  }

    if (samplePageInput && samplePageInfo) {
      const goToSamplePage = () => {
        if (!selectedIdol || !selectedIdol.answers) return;
        const totalPages = Math.ceil(selectedIdol.answers.length / SAMPLE_PAGE_SIZE);
        const targetPage = parseInt(samplePageInput.value);
        if (targetPage >= 1 && targetPage <= totalPages) {
          renderSampleList(targetPage);
        } else {
          alert(`é¡µç å¿…é¡»åœ¨ 1-${totalPages} ä¹‹é—´`);
          samplePageInput.value = currentSamplePage;
        }
      };

      samplePageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          goToSamplePage();
        }
      });

      samplePageInput.addEventListener("blur", goToSamplePage);
    }

  [apiBaseInput, apiKeyInput, modelInput].forEach((input) => {
    if (input) {
      input.addEventListener("change", saveAIConfig);
      input.addEventListener("blur", saveAIConfig);
    }
  });

  if (selectAllSamples) {
    selectAllSamples.addEventListener("click", () => {
      if (!selectedIdol) return;
      const startIndex = (currentSamplePage - 1) * SAMPLE_PAGE_SIZE;
      const endIndex = Math.min(startIndex + SAMPLE_PAGE_SIZE, selectedIdol.answers.length);
      const limit = getSampleLimit();
      const indexesToSelect = [];
      for (let i = startIndex; i < endIndex && indexesToSelect.length < limit; i++) {
        indexesToSelect.push(i);
      }
      
      indexesToSelect.forEach(idx => selectedSampleIndexes.add(idx));
      renderSampleList(currentSamplePage);
    });
  }

  if (clearSamplesButton) {
    clearSamplesButton.addEventListener("click", () => {
      selectedSampleIndexes = new Set();
      renderSampleList(currentSamplePage);
    });
  }

  if (testAIButton) {
    testAIButton.addEventListener("click", async () => {
      try {
        const { apiBase, apiKey, modelName } = getAIConfig();
        testAIButton.disabled = true;
        const originalText = testAIButton.textContent;
        testAIButton.textContent = "æµ‹è¯•ä¸­...";
        if (chatStatus) chatStatus.textContent = "AIæ¥å£æµ‹è¯•ä¸­...";
        addSystemMessage("å¼€å§‹æµ‹è¯• AI æ¥å£...");
        console.log("æµ‹è¯• AI æ¥å£ï¼Œè¯·æ±‚ URL:", `${apiBase}/v1/chat/completions`);
        const resp = await fetch(`${apiBase}/v1/chat/completions`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: modelName,
            messages: [
              { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªå¥åº·æ£€æŸ¥æœºå™¨äºº" },
              { role: "user", content: "å›å¤ä¸¤ä¸ªå­—ï¼šOK" }
            ],
            max_tokens: 10,
            temperature: 0
          })
        });

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(`HTTP ${resp.status}: ${text.slice(0, 200)}`);
        }

        const data = await resp.json();
        const content = data?.choices?.[0]?.message?.content || "";
        const preview = content.slice(0, 50) || "æ— å†…å®¹";
        addSystemMessage(`æµ‹è¯•æˆåŠŸï¼Œæ¨¡å‹å“åº”ï¼š${preview}`);
        alert(`AIæ¥å£æµ‹è¯•æˆåŠŸï¼Œæ¨¡å‹è¿”å›ï¼š${preview}`);
        if (chatStatus) chatStatus.textContent = "AIæ¥å£æµ‹è¯•é€šè¿‡";
      } catch (err) {
        console.error("AIæµ‹è¯•å¤±è´¥", err);
        let errorMessage = err.message;
        
        if (errorMessage.includes("Failed to fetch") || errorMessage.includes("NetworkError")) {
          errorMessage = "æ— æ³•è¿æ¥åˆ° Worker æœåŠ¡å™¨ã€‚è¯·æ£€æŸ¥ï¼š\n1. Worker æ˜¯å¦å·²éƒ¨ç½²\n2. Worker URL æ˜¯å¦æ­£ç¡®é…ç½®\n3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸";
        } else if (errorMessage.includes("Invalid model name") || errorMessage.includes("Invalid model")) {
          errorMessage = "æ¨¡å‹åç§°æ— æ•ˆã€‚è¯·å°è¯•ï¼š\n1. æ›´æ¢å…¶ä»–æ¨¡å‹\n2. æˆ–è®¿é—® Worker URL/v1/models æŸ¥çœ‹å¯ç”¨æ¨¡å‹åˆ—è¡¨";
        }
        
        addSystemMessage(`AIæµ‹è¯•å¤±è´¥ï¼š${errorMessage}`);
        alert(`AIæµ‹è¯•å¤±è´¥ï¼š${errorMessage}`);
        if (chatStatus) chatStatus.textContent = "AIæ¥å£æµ‹è¯•å¤±è´¥";
      } finally {
        testAIButton.disabled = false;
        testAIButton.textContent = "æµ‹è¯•";
      }
    });
  }

  if (startChatButton) {
    startChatButton.addEventListener("click", () => {
      if (!selectedIdol) {
        alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå°å¶åƒ");
        return;
      }
      chatContainer.style.display = "block";
      chatInput.disabled = false;
      sendButton.disabled = false;
      clearChatButton.disabled = false;
      chatStatus.textContent = `æ­£åœ¨ä¸ ${selectedIdol.name} èŠå¤©`;
      chatHistory = [];
      chatMessages.innerHTML = "";
      const exampleCount = getExamplesForPrompt(selectedIdol).length;
      const modeText = selectedSampleIndexes.size > 0 ? "æ‰‹åŠ¨å‹¾é€‰" : "è‡ªåŠ¨æˆªå–";
      addSystemMessage(`å·²å¼€å§‹ä¸ ${selectedIdol.name} çš„AIå¯¹è¯ï¼ŒAI å°†ä½¿ç”¨ ${exampleCount} æ¡ç¿»ç‰Œç¤ºä¾‹ï¼ˆ${modeText}ï¼Œä¸Šé™ ${getSampleLimit()} æ¡ï¼‰`);
    });
  }

  if (clearChatButton) {
    clearChatButton.addEventListener("click", () => {
      if (confirm("ç¡®å®šè¦æ¸…ç©ºèŠå¤©è®°å½•å—ï¼Ÿ")) {
        chatHistory = [];
        chatMessages.innerHTML = "";
        addSystemMessage("èŠå¤©è®°å½•å·²æ¸…ç©º");
      }
    });
  }

  if (sendButton) {
    sendButton.addEventListener("click", sendMessage);
  }

  if (chatInput) {
    chatInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  }

  function addSystemMessage(text) {
    const messageDiv = document.createElement("div");
    messageDiv.className = "message system";
    messageDiv.style.textAlign = "center";
    messageDiv.style.margin = "10px 0";
    messageDiv.innerHTML = `<span style="color: #999; font-size: 12px;">${escapeHtml(text)}</span>`;
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function addMessage(sender, text, isFan = false) {
    const messageDiv = document.createElement("div");
    messageDiv.className = `message ${isFan ? 'fan' : 'idol'}`;
    
    const senderDiv = document.createElement("div");
    senderDiv.className = "message-sender";
    senderDiv.textContent = sender;
    
    const bubbleDiv = document.createElement("div");
    bubbleDiv.className = "message-bubble";
    bubbleDiv.textContent = text;
    
    const timeDiv = document.createElement("div");
    timeDiv.className = "message-time";
    timeDiv.textContent = new Date().toLocaleTimeString("zh-CN", { hour: '2-digit', minute: '2-digit' });
    
    messageDiv.appendChild(senderDiv);
    messageDiv.appendChild(bubbleDiv);
    messageDiv.appendChild(timeDiv);
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  async function sendMessage() {
    const message = chatInput.value.trim();
    if (!message || !selectedIdol) {
      return;
    }

    chatInput.disabled = true;
    sendButton.disabled = true;
    sendButton.textContent = "å‘é€ä¸­...";

    addMessage("æˆ‘", message, true);
    chatHistory.push({ role: "user", content: message });
    chatInput.value = "";

    try {
      const systemPrompt = buildSystemPrompt(selectedIdol);
      const response = await callAI(systemPrompt, chatHistory);
      
      addMessage(selectedIdol.name, response, false);
      chatHistory.push({ role: "assistant", content: response });
    } catch (error) {
      console.error("AIè°ƒç”¨å¤±è´¥:", error);
      addMessage("ç³»ç»Ÿ", "æŠ±æ­‰ï¼ŒAIå›å¤å¤±è´¥ï¼š" + error.message, false);
    } finally {
      chatInput.disabled = false;
      sendButton.disabled = false;
      sendButton.textContent = "å‘é€";
      chatInput.focus();
    }
  }

  function buildSystemPrompt(idol) {
    const examples = getExamplesForPrompt(idol);
    let prompt = `ä½ æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹ï¼Œéœ€è¦æ¨¡ä»¿${idol.name}çš„è¯´è¯æ–¹å¼å’Œé£æ ¼ã€‚\n\n`;
    prompt += `ä»¥ä¸‹æ˜¯${idol.name}çš„çœŸå®ç¿»ç‰Œè®°å½•ï¼Œè¯·ä»”ç»†å­¦ä¹ å…¶è¯´è¯é£æ ¼ã€ç”¨è¯ä¹ æƒ¯ã€è¯­æ°”ç‰¹ç‚¹ï¼š\n\n`;
    
    examples.forEach((item, index) => {
      prompt += `ã€ç¤ºä¾‹${index + 1}ã€‘\n`;
      prompt += `ç²‰ä¸æé—®ï¼š${item.question}\n`;
      prompt += `${idol.name}å›ç­”ï¼š${item.answer}\n\n`;
    });
    
    prompt += `è¯·æ ¹æ®ä»¥ä¸Šç¤ºä¾‹ï¼Œæ¨¡ä»¿${idol.name}çš„è¯´è¯æ–¹å¼ä¸ç²‰ä¸å¯¹è¯ã€‚è¦æ±‚ï¼š\n`;
    prompt += `1. è¯­æ°”å’Œé£æ ¼è¦ä¸ç¤ºä¾‹ä¿æŒä¸€è‡´\n`;
    prompt += `2. ç”¨è¯ä¹ æƒ¯è¦ç¬¦åˆè¯¥å¶åƒçš„ç‰¹ç‚¹\n`;
    prompt += `3. å›ç­”è¦è‡ªç„¶ã€äº²åˆ‡ï¼Œç¬¦åˆå¶åƒä¸ç²‰ä¸çš„äº’åŠ¨æ–¹å¼\n`;
    prompt += `4. å¦‚æœé—®é¢˜æ¶‰åŠéšç§æˆ–ä¸é€‚åˆå›ç­”ï¼Œå¯ä»¥å§”å©‰æ‹’ç»\n`;
    prompt += `5. å›ç­”é•¿åº¦é€‚ä¸­ï¼Œä¸è¦å¤ªé•¿ä¹Ÿä¸è¦å¤ªçŸ­\n`;
    
    return prompt;
  }

  async function callAI(systemPrompt, history) {
    const { apiBase, apiKey, modelName } = getAIConfig();
    const messages = [
      { role: "system", content: systemPrompt },
      ...history
    ];

    try {
      const response = await fetch(`${apiBase}/v1/chat/completions`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: modelName,
          messages: messages,
          temperature: 0.7,
          max_tokens: 4096
        })
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
      }

      const data = await response.json();
      
      if (data.choices && data.choices.length > 0) {
        return data.choices[0].message.content.trim();
      } else {
        throw new Error("APIè¿”å›æ ¼å¼é”™è¯¯");
      }
      } catch (error) {
        if (error.message.includes("Failed to fetch") || error.message.includes("NetworkError")) {
          throw new Error("æ— æ³•è¿æ¥åˆ° Worker æœåŠ¡å™¨ã€‚è¯·æ£€æŸ¥ Worker æ˜¯å¦å·²éƒ¨ç½²ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜ã€‚");
        } else if (error.message.includes("Invalid model name") || error.message.includes("Invalid model")) {
          throw new Error(`æ¨¡å‹åç§°æ— æ•ˆï¼š${modelName}ã€‚è¯·å°è¯•ï¼š\n1. æ›´æ¢å…¶ä»–æ¨¡å‹\n2. åˆ·æ–°é¡µé¢æ¸…é™¤ç¼“å­˜\n3. è®¿é—® ${apiBase}/v1/models æŸ¥çœ‹å¯ç”¨æ¨¡å‹åˆ—è¡¨`);
        }
        throw error;
      }
    }

  if (filterType) {
    filterType.addEventListener("change", applyFilter);
  }
  if (filterStatus) {
    filterStatus.addEventListener("change", applyFilter);
  }
  if (sortCost) {
    sortCost.addEventListener("change", applyFilter);
  }
  if (filterDateStart) {
    filterDateStart.addEventListener("change", applyFilter);
  }
  if (filterDateEnd) {
    filterDateEnd.addEventListener("change", applyFilter);
  }
  if (sortTime) {
    sortTime.addEventListener("change", applyFilter);
  }
  if (filterKeyword) {
    filterKeyword.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        searchAndLocate();
      }
    });
  }
  if (filterScopeRadios && filterScopeRadios.length > 0) {
    filterScopeRadios.forEach((radio) => {
      radio.addEventListener("change", () => {
        applyFilter();
      });
    });
  }
  if (searchButton) {
    searchButton.addEventListener("click", searchAndLocate);
  }
  
  if (clearSearchButton) {
    clearSearchButton.addEventListener("click", () => {
      filterKeyword.value = "";
      lastKeyword = "";
      applyFilter();
      clearSearchButton.style.display = "none";
    });
  }
  if (prevPage) {
    prevPage.addEventListener("click", () => {
      if (currentPage > 1) {
        renderTable(filteredRows.length > 0 ? filteredRows : viewRows, currentPage - 1);
      }
    });
  }
  if (nextPage) {
    nextPage.addEventListener("click", () => {
      const totalPages = Math.ceil((filteredRows.length > 0 ? filteredRows : viewRows).length / pageSize);
      if (currentPage < totalPages) {
        renderTable(filteredRows.length > 0 ? filteredRows : viewRows, currentPage + 1);
      }
    });
  }
  if (goToPage && pageInput) {
    goToPage.addEventListener("click", () => {
      const targetPage = parseInt(pageInput.value);
      const rows = filteredRows.length > 0 ? filteredRows : viewRows;
      const totalPages = Math.ceil(rows.length / pageSize);
      if (targetPage >= 1 && targetPage <= totalPages) {
        renderTable(rows, targetPage);
      } else {
        alert(`é¡µç å¿…é¡»åœ¨ 1-${totalPages} ä¹‹é—´`);
        pageInput.value = currentPage;
      }
    });
    pageInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        goToPage.click();
      }
    });
  }


  if (exportButton) {
    exportButton.addEventListener("click", () => {
      try {
        if (typeof XLSX === 'undefined') {
          alert("Excelå¯¼å‡ºåŠŸèƒ½éœ€è¦åŠ è½½XLSXåº“ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
          console.error("XLSXåº“æœªåŠ è½½");
          return;
        }

        if (!rawAnswerList.length) {
          alert("æš‚æ— æ•°æ®å¯å¯¼å‡ºï¼Œè¯·å…ˆè·å–ç¿»ç‰Œæ•°æ®");
          return;
        }

        exportButton.disabled = true;
        exportButton.textContent = "æ­£åœ¨å¯¼å‡º...";

        const allRowsToExport = rawAnswerList.map(mapAnswerToRow);
        
        const excelData = allRowsToExport.map((row) => ({
          "ç±»å‹": row.type || "",
          "å¶åƒå": row.member || "",
          "æé—®æ—¶é—´": row.questionDateTime || "",
          "å›ç­”æ—¶é—´": row.answerDateTime || "",
          "ç¿»ç‰Œæé—®å†…å®¹": row.questionContent || "",
          "ç¿»ç‰Œå›ç­”å†…å®¹": row.answerContent || "",
          "çŠ¶æ€": row.status === 2 ? "å·²ç¿»" : (row.status === 1 ? "å¾…ç¿»" : "æœªç¿»/å·²é€€æ¬¾"),
          "é¸¡è…¿æ•°": row.cost || 0
        }));

        const ws = XLSX.utils.json_to_sheet(excelData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ç¿»ç‰Œè®°å½•");

        const idText = selectedId.textContent.replace(/[()ID:\s]/g, "") || "";
        const nick   = selectedNickname.textContent || "";
        const name =
          (idText || nick)
            ? `${idText || "id"}-${nick || "user"}-ç¿»ç‰Œè®°å½•.xlsx`
            : "pocket48_ç¿»ç‰Œè®°å½•.xlsx";

        XLSX.writeFile(wb, name);
        
        setTimeout(() => {
          exportButton.disabled = false;
          exportButton.textContent = "å¯¼å‡º Excel";
          alert(`å¯¼å‡ºæˆåŠŸï¼å…±å¯¼å‡º ${allRowsToExport.length} æ¡è®°å½•ï¼ˆåŒ…å«æ‰€æœ‰çŠ¶æ€ï¼‰\n\næ–‡ä»¶åï¼š${name}\nä¿å­˜ä½ç½®ï¼šæµè§ˆå™¨é»˜è®¤ä¸‹è½½æ–‡ä»¶å¤¹`);
        }, 500);
      } catch (error) {
        console.error("å¯¼å‡ºExcelæ—¶å‡ºé”™:", error);
        alert("å¯¼å‡ºå¤±è´¥ï¼š" + error.message + "\nè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯");
        exportButton.disabled = false;
        exportButton.textContent = "å¯¼å‡º Excel";
      }
    });
  }

  if (previewButton) {
    previewButton.addEventListener("click", () => {
      try {
        if (!rawAnswerList.length) {
          alert("æš‚æ— æ•°æ®å¯é¢„è§ˆï¼Œè¯·å…ˆè·å–ç¿»ç‰Œæ•°æ®");
          return;
        }

        previewButton.disabled = true;
        previewButton.textContent = "ç”Ÿæˆä¸­...";

        const allRowsToExport = rawAnswerList.map(mapAnswerToRow);
        const idText = selectedId.textContent.replace(/[()ID:\s]/g, "") || "";
        const nick   = selectedNickname.textContent || "";
        const title = (idText || nick) ? `${nick}çš„ç¿»ç‰Œè®°å½•` : "å£è¢‹48ç¿»ç‰Œè®°å½•";
        const fileName = (idText || nick) ? `${idText || "id"}-${nick || "user"}-ç¿»ç‰Œè®°å½•.html` : "å£è¢‹48ç¿»ç‰Œè®°å½•.html";

        const previewHTML = generatePreviewHTML(allRowsToExport, title);
        const previewWindow = window.open('', '_blank');
        
        if (previewWindow && !previewWindow.closed) {
          previewWindow.document.write(previewHTML);
          previewWindow.document.close();
        } else {
          const blob = new Blob([previewHTML], { type: 'text/html;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          a.style.display = 'none';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          setTimeout(() => URL.revokeObjectURL(url), 100);
        }

        previewButton.disabled = false;
        previewButton.textContent = "é¢„è§ˆ/ä¸‹è½½";
      } catch (error) {
        console.error("ç”Ÿæˆé¢„è§ˆæ—¶å‡ºé”™:", error);
        alert("âŒ é¢„è§ˆå¤±è´¥ï¼š" + error.message + "\n\nè¯·å°è¯•ä½¿ç”¨ã€Œå¯¼å‡º Excelã€åŠŸèƒ½");
        previewButton.disabled = false;
        previewButton.textContent = "é¢„è§ˆ/ä¸‹è½½";
      }
    });
  }

  function generatePreviewHTML(rows, title) {
    const date = new Date().toLocaleDateString('zh-CN');
    const time = new Date().toLocaleString('zh-CN');
    let tableRows = '';
    rows.forEach((row, index) => {
      const statusText = row.status === 2 ? 'âœ… å·²ç¿»' : (row.status === 1 ? 'â³ å¾…ç¿»' : 'âŒ é€€å›');
      const costColor = row.status === 2 ? '#dc3545' : '#999';
      
      tableRows += `
        <tr>
          <td style="text-align: center;">${index + 1}</td>
          <td style="text-align: center;">${escapeHtml(row.type)}</td>
          <td><strong>${escapeHtml(row.member)}</strong></td>
          <td style="font-size: 12px; color: #666;">${escapeHtml(row.questionDateTime)}</td>
          <td style="max-width: 250px; word-wrap: break-word; white-space: pre-wrap;">${escapeHtml(row.questionContent)}</td>
          <td style="max-width: 250px; word-wrap: break-word; white-space: pre-wrap;">${escapeHtml(row.answerContent)}</td>
          <td style="text-align: center;">${statusText}</td>
          <td style="text-align: right; color: ${costColor}; font-weight: bold;">${row.cost.toFixed(2)}</td>
        </tr>
      `;
    });

    return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>${escapeHtml(title)} - ${date}</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      padding: 10px;
      background: #f5f5f7;
      font-size: 14px;
      line-height: 1.6;
    }
    .header {
      background: white;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .header h1 {
      font-size: 20px;
      margin-bottom: 8px;
      color: #333;
    }
    .header .info {
      color: #666;
      font-size: 12px;
    }
    .table-container {
      background: white;
      border-radius: 12px;
      overflow-x: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 15px;
    }
    table {
      width: 100%;
      min-width: 800px;
      border-collapse: collapse;
      font-size: 13px;
    }
    thead {
      background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    th {
      padding: 12px 8px;
      text-align: left;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #dee2e6;
      white-space: nowrap;
    }
    td {
      padding: 10px 8px;
      border-bottom: 1px solid #f0f0f0;
      color: #555;
    }
    tr:nth-child(even) {
      background: #fafafa;
    }
    tr:hover {
      background: #f0f8ff !important;
    }
    .footer {
      text-align: center;
      margin-top: 15px;
      padding: 15px;
      color: #999;
      font-size: 12px;
      background: white;
      border-radius: 10px;
    }
    @media print {
      body { background: white; padding: 0; }
      .header, .table-container { box-shadow: none; }
    }
    @media (max-width: 768px) {
      body { padding: 5px; }
      .header h1 { font-size: 18px; }
      table { font-size: 12px; min-width: 600px; }
      th, td { padding: 8px 5px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>${escapeHtml(title)}</h1>
    <div class="info">
      ğŸ“… å¯¼å‡ºæ—¥æœŸï¼š${date} | ğŸ“Š å…± ${rows.length} æ¡è®°å½•
    </div>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th style="width: 40px;">#</th>
          <th style="width: 60px;">ç±»å‹</th>
          <th style="width: 100px;">å¶åƒå</th>
          <th style="width: 140px;">æé—®æ—¶é—´</th>
          <th style="min-width: 200px;">æé—®å†…å®¹</th>
          <th style="min-width: 200px;">å›ç­”å†…å®¹</th>
          <th style="width: 70px;">çŠ¶æ€</th>
          <th style="width: 70px;">é¸¡è…¿æ•°</th>
        </tr>
      </thead>
      <tbody>
        ${tableRows}
      </tbody>
    </table>
  </div>

  <div class="footer">
    ğŸµ å£è¢‹48ç¿»ç‰Œè®°å½•æ£€ç´¢å·¥å…·<br>
    â° å¯¼å‡ºæ—¶é—´ï¼š${time}
  </div>
</body>
</html>`;
  }

  function calculateStats() {
    if (!rawAnswerList.length) {
      alert("æš‚æ— æ•°æ®ï¼Œè¯·å…ˆè·å–ç¿»ç‰Œæ•°æ®");
      return;
    }

    const statsMap = new Map();

    rawAnswerList.forEach((answer) => {
      const isAnswered = answer.status === 2;
      if (!isAnswered) {
        return;
      }

      const memberName =
        (answer.baseUserInfo && (answer.baseUserInfo.nickname || answer.baseUserInfo.starName)) ||
        (answer.memberName) ||
        "æœªçŸ¥æˆå‘˜";
      
      const memberId = 
        (answer.baseUserInfo && answer.baseUserInfo.userId) ||
        (answer.memberId) ||
        memberName;

      const price = 
        answer.price || 
        answer.cost || 
        answer.money || 
        answer.amount ||
        0;
      
      const priceNum = parseFloat(price) || 0;

      if (!statsMap.has(memberId)) {
        statsMap.set(memberId, {
          memberName: memberName,
          count: 0,
          totalPrice: 0
        });
      }

      const stat = statsMap.get(memberId);
      stat.count += 1;
      stat.totalPrice += priceNum;
    });

    const statsArray = Array.from(statsMap.values()).sort((a, b) => b.totalPrice - a.totalPrice);

    statsTableBody.innerHTML = "";
    
    if (statsArray.length === 0) {
      statsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-4">æš‚æ— ç»Ÿè®¡æ•°æ®</td></tr>';
      statsInfo.textContent = "";
      return;
    }

    let totalCount = 0;
    let totalPrice = 0;

    statsArray.forEach((stat) => {
      totalCount += stat.count;
      totalPrice += stat.totalPrice;
      
    
      const avgPrice = stat.count > 0 ? (stat.totalPrice / stat.count).toFixed(2) : "0.00";
      
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="fw-bold">${escapeHtml(stat.memberName)}</td>
        <td>${stat.count}</td>
        <td class="text-danger fw-bold">${stat.totalPrice.toFixed(2)}</td>
        <td class="text-muted">${avgPrice}</td>
      `;
      statsTableBody.appendChild(tr);
    });

    statsInfo.textContent = `å…±ç»Ÿè®¡ ${statsArray.length} ä½æˆå‘˜ï¼Œæ€»è®¡ ${totalCount} æ¡å·²ç¿»ç¿»ç‰Œï¼Œæ€»èŠ±è´¹ ${totalPrice.toFixed(2)} é¸¡è…¿`;

    statsContainer.style.display = "block";
  }

  if (showStatsButton) {
    showStatsButton.addEventListener("click", () => {
      calculateStats();
    });
  }

  loadAIConfig();
  updateSampleHelper();
});
</script>
</script>

<div style="text-align: center; margin-top: 20px; font-size: 14px; color: #666;">
  <p>
    æœ¬é¡¹ç›®å·²å¼€æºäº 
    <a href="https://github.com/Dev-XZY/popcan48" target="_blank" style="text-decoration: none; color: #333; font-weight: bold;">
      <svg height="20" width="20" viewBox="0 0 16 16" style="vertical-align: middle; margin-right: 4px;">
        <path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
      </svg>
      GitHub
    </a>
  </p>
</div>
</body>
</html>
